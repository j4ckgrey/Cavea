<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Cavea - Media Streaming Helper</title>
</head>

<body>
    <div id="CaveaConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <div style="text-align: center; margin-bottom: 20px;">
                    <!-- Plugin logo loaded from GitHub (plugins can't serve static files via HTTP GET) -->
                    <img src="https://raw.githubusercontent.com/j4ckgrey/Cavea/main/Cavea.png" alt="Cavea Logo"
                        style="max-width: 200px; height: auto; border-radius: 8px;"
                        onerror="this.style.display='none';">
                </div>
                <h2 style="text-align: center;">Cavea - Media Request Manager</h2>
                <h3 style="text-align: center;">Plugin Settings</h3>



                <!-- API Keys -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">API Keys</h4>

                    <div style="margin-bottom: 16px;">
                        <label for="tmdbApiKey" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">TMDB
                            API Key (required for Modals Metadata)</label>
                        <input id="tmdbApiKey" type="text" placeholder="Enter TMDB API Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label for="traktClientId"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Trakt
                            Client ID (required for Trakt reviews)</label>
                        <input id="traktClientId" type="text" placeholder="Enter Trakt Client ID"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                        <p style="margin: 4px 0 0 0; font-size: 11px; color: #888;">
                            Get your free API key at <a href="https://trakt.tv/oauth/applications" target="_blank"
                                style="color: #1e90ff;">trakt.tv/oauth/applications</a>
                        </p>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label for="rapidApiKey"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">RapidAPI
                            Key (required for IMDb reviews)</label>
                        <input id="rapidApiKey" type="text" placeholder="Enter RapidAPI Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                        <p style="margin: 4px 0 0 0; font-size: 11px; color: #888;">
                            subscribe to <strong>IMDb8</strong> API at <a href="https://rapidapi.com/apidojo/api/imdb8"
                                target="_blank" style="color: #1e90ff;">RapidAPI</a> (free tier available)
                        </p>
                    </div>

                </div>

                <!-- Search Filter Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Search Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="forceTVClientLocalSearch" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Force Local Search for TV Clients</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, all TV clients will only see local library results. This is useful for
                            restricting external search on shared/public servers.
                        </p>
                    </div>
                </div>

                <!-- Request Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Request Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="enableAutoImport" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Auto Import</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, non-admin users will be able to "Import" directly instead of "Request" for
                            items in the library.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="disableModal" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Disable Modal</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            Directly open items on click when Auto Import is enabled (bypasses details modal).
                        </p>
                    </div>
                </div>


                <!-- External Subtitles Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">External Subtitles</h4>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="enableExternalSubtitles" type="checkbox"
                                style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="color:#ddd; font-weight: 600;">Enable External Subtitles from Gelato</span>
                        </label>
                        <p style="margin: 8px 0 0 28px; font-size: 12px; color: #aaa; line-height: 1.5;">
                            When enabled, Cavea will automatically fetch external subtitles from Gelato/Stremio and
                            cache them permanently.
                            Subtitles are served through Cavea's proxy to prevent Jellyfin from disposing them.
                        </p>
                        <div
                            style="margin: 12px 0 0 28px; padding: 12px; background: rgba(30,144,255,0.1); border-left: 3px solid #1e90ff; border-radius: 4px;">
                            <p style="margin: 0 0 6px 0; font-size: 12px; color: #1e90ff; font-weight: 600;">‚ÑπÔ∏è How It
                                Works</p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #bbb; line-height: 1.6;">
                                <li>External subtitles from Gelato are cached in Cavea's database</li>
                                <li>Subtitles are proxied through <code>/api/cavea/subtitles/proxy</code></li>
                                <li>Automatically fetched when you play videos</li>
                            </ul>
                        </div>
                    </div>
                </div>








                <!-- Catalogs Management -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h4 style="margin: 0; color: #1e90ff;">Catalogs</h4>
                            <!-- Hamburger Filter Menu -->
                            <div style="position: relative;">
                                <button id="catalogFilterBtn" type="button"
                                    style="background: transparent; border: 1px solid #444; color: #ccc; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 16px;"
                                    title="Filter catalogs">‚ò∞</button>
                                <div id="catalogFilterDropdown"
                                    style="display: none; position: absolute; top: 100%; left: 0; background: #222; border: 1px solid #444; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100; min-width: 140px; margin-top: 4px;">
                                    <button type="button" data-filter="all"
                                        style="display: block; width: 100%; padding: 8px 12px; background: transparent; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px;"
                                        class="catalog-filter-option active">All</button>
                                    <button type="button" data-filter="imported"
                                        style="display: block; width: 100%; padding: 8px 12px; background: transparent; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px;"
                                        class="catalog-filter-option">Imported</button>
                                    <button type="button" data-filter="not-imported"
                                        style="display: block; width: 100%; padding: 8px 12px; background: transparent; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px;"
                                        class="catalog-filter-option">Not Imported</button>
                                </div>
                            </div>
                            <span id="catalogFilterLabel"
                                style="font-size: 11px; color: #888; margin-left: 4px;">(All)</span>
                        </div>

                        <div style="flex: 1; display: flex; justify-content: center; margin: 0 20px;">
                            <input id="catalogSearchInput" type="text" placeholder="Search catalogs..."
                                style="width: 100%; max-width: 300px; padding: 6px 12px; border: 1px solid #444; border-radius: 4px; background: #111; color: white; font-size: 13px;" />
                        </div>

                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 12px; color: #999;">Max items:</label>
                            <input id="catalogsMaxItems" type="number" min="1" max="500" value="100" style="width: 60px; padding: 4px 8px; border: 1px solid #1e90ff; 
                                          border-radius: 4px; background: rgba(30,144,255,0.1); 
                                          color: white; font-size: 13px;" />
                            <button id="catalogsRefreshBtn" type="button"
                                style="padding: 6px 12px; border: none; background: #1e90ff; color: white; border-radius: 4px; cursor: pointer; font-size: 13px;">Refresh</button>
                        </div>
                    </div>
                    <p style="margin: 0 0 12px 0; font-size: 12px; color: #999;">
                        Manage aiostreams catalogs from Gelato. Create collections or import items directly to your
                        library.
                    </p>
                    <!-- Bulk Selection Controls -->
                    <div id="catalogsBulkControls"
                        style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin-bottom: 8px; background: rgba(30,144,255,0.1); border-radius: 6px; border: 1px solid rgba(30,144,255,0.3);">
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                            <input id="catalogSelectAll" type="checkbox"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">Select All</span>
                        </label>
                        <button id="catalogsImportSelectedBtn" type="button" disabled
                            style="padding: 8px 16px; border: none; background: #1e90ff; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; opacity: 0.5;">
                            Import Selected (<span id="catalogsSelectedCount">0</span>)
                        </button>
                    </div>
                    <div id="catalogsLoading" style="display: none; text-align: center; padding: 20px; color: #888;">
                        Loading catalogs...
                    </div>
                    <div id="catalogsError"
                        style="display: none; padding: 10px; color: #e74c3c; background: rgba(231,76,60,0.1); border-radius: 4px;">
                    </div>
                    <div id="catalogsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- UI Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">UI Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="enableCaveaUI" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Cavea UI Injection</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            Injects custom UI scripts into Jellyfin. Disable to revert to standard UI.
                            <strong>Refresh page</strong> to apply.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="showReviewsCarousel" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Reviews in details pages</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, a carousel of user reviews will be displayed above the Cast & Crew section on
                            movie and TV show details pages.
                        </p>
                    </div>

                    <div style="margin-bottom: 16px; margin-left: 28px;">
                        <label for="reviewSource"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Review Source</label>
                        <select id="reviewSource"
                            style="width:200px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;cursor:pointer;">
                            <option value="tmdb">TMDB</option>
                            <option value="trakt">Trakt</option>
                            <option value="imdb">IMDb (via RapidAPI)</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 11px; color: #888;">
                            Choose where to fetch reviews from. Ensure the corresponding API key is configured above.
                        </p>

                        <!-- RapidAPI IMDb Help Section -->
                        <div
                            style="margin-top: 12px; padding: 12px; background: rgba(30,144,255,0.1); border-left: 3px solid #1e90ff; border-radius: 4px;">
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #1e90ff; font-weight: 600;">üìå About
                                IMDb Reviews (RapidAPI)</p>
                            <p style="margin: 0 0 6px 0; font-size: 11px; color: #bbb;">
                                To use IMDb reviews, you need to subscribe to the <strong>IMDb8 API</strong> on
                                RapidAPI:
                            </p>
                            <ul style="margin: 6px 0 6px 16px; padding: 0; font-size: 11px; color: #bbb;">
                                <li style="margin-bottom: 4px;">
                                    <strong>API:</strong> <a href="https://rapidapi.com/apidojo/api/imdb8"
                                        target="_blank" style="color: #1e90ff;">IMDb8 by ApiDojo</a>
                                </li>
                                <li style="margin-bottom: 4px;">
                                    <strong>Cost:</strong> Free tier (BASIC) - $0.00/month
                                </li>
                                <li style="margin-bottom: 4px;">
                                    <strong>Quota:</strong> Free tier includes sufficient requests for personal use
                                </li>
                                <li>
                                    <strong>Steps:</strong> Visit the link above ‚Üí Click "Subscribe" ‚Üí Choose BASIC
                                    (free) ‚Üí Use your RapidAPI key above
                                </li>
                            </ul>
                            <p style="margin: 6px 0 0 0; font-size: 10px; color: #999;">
                                üí° Tip: You can also use Trakt for reviews, which doesn't require subscription (just
                                OAuth token)
                            </p>
                        </div>
                    </div>
                    </p>
                </div>

                <div style="margin-bottom: 12px;">
                    <label for="versionUiSelect"
                        style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Version
                        UI</label>
                    <select id="versionUiSelect"
                        style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                        <option value="carousel">Carousel</option>
                        <option value="dropdown">Dropdown</option>
                    </select>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                        Choose UI for version selection.
                    </p>
                </div>

                <div style="margin-bottom: 12px;">
                    <label for="audioUiSelect" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Audio
                        UI</label>
                    <select id="audioUiSelect"
                        style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                        <option value="carousel">Carousel</option>
                        <option value="dropdown">Dropdown</option>
                    </select>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                        Choose UI for audio track selection.
                    </p>
                </div>

                <div style="margin-bottom: 12px;">
                    <label for="subtitleUiSelect"
                        style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Subtitle
                        UI</label>
                    <select id="subtitleUiSelect"
                        style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                        <option value="carousel">Carousel</option>
                        <option value="dropdown">Dropdown</option>
                    </select>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                        Choose UI for subtitle selection.
                    </p>
                </div>
            </div>


        </div>



        <!-- Create Library Confirmation Modal -->
        <div id="createLibraryModal"
            style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: #222; padding: 20px; border-radius: 8px; width: 450px; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                <h3 style="margin-top: 0; color: #1e90ff;">Create Collection from Catalog?</h3>
                <p style="color: #ddd; font-size: 14px; line-height: 1.5; margin-bottom: 10px;">
                    You are about to create a new Jellyfin Collection for: <br><strong id="createLibraryName"
                        style="color:white; font-size:16px;"></strong>
                </p>
                <p style="color: #aaa; font-size: 13px; margin-bottom: 20px;">
                    This will:<br>
                    1. Create a physical folder.<br>
                    2. Create a virtual collection in Jellyfin.<br>
                    3. Import items from the catalog via Gelato.<br>
                </p>

                <label for="createLibraryInputName"
                    style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Collection
                    Name</label>
                <input id="createLibraryInputName" type="text"
                    style="width:100%;padding:8px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;box-sizing: border-box;">

                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="cancelCreateLibBtn"
                        style="padding: 8px 16px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button id="confirmCreateLibBtn"
                        style="padding: 8px 16px; background: #1e90ff; color: white; border: none; border-radius: 4px; cursor: pointer;">Create
                        Collection</button>
                </div>
            </div>
        </div>

        <!-- Bulk Import Modal -->
        <div id="bulkImportModal"
            style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: #222; padding: 20px; border-radius: 8px; width: 550px; max-height: 80vh; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column;">
                <h3 style="margin-top: 0; color: #1e90ff;">Import Catalogs</h3>
                <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">
                    <span id="bulkImportCount">0</span> catalogs selected. Each catalog will be imported one at a
                    time.
                </p>

                <!-- Progress Bar (hidden initially) -->
                <div id="bulkImportProgress" style="display: none; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #ddd; font-size: 12px;">Progress</span>
                        <span id="bulkImportProgressText" style="color: #2ecc71; font-size: 12px;">0/0</span>
                    </div>
                    <div style="background: #333; border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="bulkImportProgressBar"
                            style="background: #1e90ff; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>

                <!-- Scrollable List of Catalogs -->
                <div id="bulkImportList"
                    style="flex: 1; overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 10px;">
                    <!-- Populated by JS -->
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <button id="cancelBulkImportBtn"
                        style="padding: 8px 16px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button id="confirmBulkImportBtn"
                        style="padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Start Import</button>
                </div>
            </div>
        </div>

        <!-- Update Preview Modal -->
        <div id="updatePreviewModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: #222; padding: 20px; border-radius: 8px; width: 450px; color: white; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                <h3 style="margin-top: 0; color: #2ecc71;">Collection Status</h3>

                <div style="margin: 20px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Existing Items:</span>
                        <span id="previewExisting" style="font-weight: bold; color: #bdc3c7;">Loading...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>New Items (Missing):</span>
                        <span id="previewNew" style="font-weight: bold; color: #2ecc71;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Removed Items (Extra):</span>
                        <span id="previewRemoved" style="font-weight: bold; color: #e74c3c;">-</span>
                    </div>
                    <div
                        style="margin-top: 10px; border-top: 1px solid #444; padding-top: 8px; text-align: center; color: #888; font-size: 0.9em;">
                        Total in Catalog: <span id="previewTotal">-</span>
                    </div>
                </div>

                <div id="previewMessage" style="margin-bottom: 20px; text-align: center; font-style: italic;">
                    Checking for updates...
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="closePreviewBtn"
                        style="padding: 8px 16px; border: none; background: #555; color: white; border-radius: 4px; cursor: pointer;">Close</button>
                    <button id="confirmUpdateBtn"
                        style="padding: 8px 16px; border: none; background: #2ecc71; color: white; border-radius: 4px; cursor: pointer; display: none;">Update
                        Collection</button>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding-bottom: 60px;">
            <button id="saveConfigBtn"
                style="padding:8px 16px;border-radius:4px;border:none;background:#1e90ff;color:#fff;cursor:pointer;font-size:14px;">Save
                Configuration</button>
            <div id="configStatus" style="margin-top:8px;color:#ccc;font-size:13px;"></div>
        </div>

        <script>
            async function loadConfig() {
                try {
                    if (window.ApiClient && window.ApiClient.ajax) {
                        let response = await window.ApiClient.ajax({ type: 'GET', url: window.ApiClient.getUrl('api/cavea/config'), dataType: 'json' });
                        if (response && response.constructor && response.constructor.name === 'Response') response = await response.json();
                        document.getElementById('tmdbApiKey').value = response?.tmdbApiKey || '';
                        document.getElementById('traktClientId').value = response?.traktClientId || '';
                        document.getElementById('rapidApiKey').value = response?.rapidApiKey || '';
                        document.getElementById('forceTVClientLocalSearch').checked = response?.forceTVClientLocalSearch === true;
                        document.getElementById('enableAutoImport').checked = response?.enableAutoImport === true;
                        document.getElementById('disableModal').checked = response?.disableModal === true;
                        document.getElementById('showReviewsCarousel').checked = response?.showReviewsCarousel !== false;
                        document.getElementById('reviewSource').value = response?.reviewSource || 'tmdb';
                        document.getElementById('versionUiSelect').value = response?.versionUi || 'carousel';
                        document.getElementById('audioUiSelect').value = response?.audioUi || 'carousel';
                        document.getElementById('audioUiSelect').value = response?.audioUi || 'carousel';
                        document.getElementById('subtitleUiSelect').value = response?.subtitleUi || 'carousel';
                        document.getElementById('catalogsMaxItems').value = response?.catalogMaxItems || 100;
                        // document.getElementById('useCaveaCache').checked = response?.useCaveaCache === true;
                        // document.getElementById('useCaveaStaging').checked = response?.useCaveaStaging !== false;
                        document.getElementById('enableExternalSubtitles').checked = response?.enableExternalSubtitles === true;

                        // UI Injection Toggle
                        const val = response?.enableCaveaUI ?? response?.EnableCaveaUI;
                        document.getElementById('enableCaveaUI').checked = (val === undefined) ? true : val;

                        console.log('[Cavea][Config] Loaded config:', response);
                        return;
                    }

                    const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/cavea/config') : (window.location.origin + '/api/cavea/config');
                    const res = await fetch(url + '?v=' + new Date().getTime(), { credentials: 'same-origin' });
                    if (!res.ok) throw new Error('Failed to load config');
                    const json = await res.json();
                    console.log('[Cavea][Config] Raw config response:', json);

                    document.getElementById('tmdbApiKey').value = json.tmdbApiKey || '';
                    document.getElementById('traktClientId').value = json.traktClientId || '';
                    document.getElementById('rapidApiKey').value = json.rapidApiKey || '';
                    document.getElementById('forceTVClientLocalSearch').checked = json.forceTVClientLocalSearch === true;
                    document.getElementById('enableAutoImport').checked = json.enableAutoImport === true;
                    document.getElementById('disableModal').checked = json.disableModal === true;
                    document.getElementById('showReviewsCarousel').checked = json.showReviewsCarousel !== false;
                    document.getElementById('reviewSource').value = json.reviewSource || 'tmdb';
                    document.getElementById('versionUiSelect').value = json.versionUi || 'carousel';
                    document.getElementById('audioUiSelect').value = json.audioUi || 'carousel';
                    document.getElementById('audioUiSelect').value = json.audioUi || 'carousel';
                    document.getElementById('subtitleUiSelect').value = json.subtitleUi || 'carousel';
                    document.getElementById('catalogsMaxItems').value = json.catalogMaxItems || 100;
                    // document.getElementById('useCaveaCache').checked = json.useCaveaCache === true;
                    // document.getElementById('useCaveaStaging').checked = json.useCaveaStaging !== false;
                    document.getElementById('enableExternalSubtitles').checked = json.enableExternalSubtitles === true;


                    // UI Injection Toggle
                    const val2 = json.enableCaveaUI ?? json.EnableCaveaUI;
                    console.log('[Cavea] Loaded raw EnableCaveaUI:', val2);
                    document.getElementById('enableCaveaUI').checked = (val2 === undefined) ? true : val2;

                    console.log('[Cavea][Config] Config loaded setup complete');
                } catch (e) {
                    console.error('[Cavea][Config] Load error:', e);
                    document.getElementById('configStatus').textContent = 'Error loading config: ' + e.message;
                }
            }



            document.getElementById('saveConfigBtn').addEventListener('click', async () => {
                const key = document.getElementById('tmdbApiKey').value;
                const traktClientId = document.getElementById('traktClientId').value;
                const rapidApiKey = document.getElementById('rapidApiKey').value;
                const forceTVLocal = document.getElementById('forceTVClientLocalSearch').checked;
                const enableAutoImport = document.getElementById('enableAutoImport').checked;
                const disableModal = document.getElementById('disableModal').checked;
                const showReviewsCarousel = document.getElementById('showReviewsCarousel').checked;
                const reviewSource = document.getElementById('reviewSource').value;


                const versionUi = document.getElementById('versionUiSelect').value;
                const audioUi = document.getElementById('audioUiSelect').value;
                const subtitleUi = document.getElementById('subtitleUiSelect').value;
                const enableCaveaUI = document.getElementById('enableCaveaUI').checked;
                // const useCaveaCache = document.getElementById('useCaveaCache').checked;
                // const useCaveaStaging = document.getElementById('useCaveaStaging').checked;
                const enableExternalSubtitles = document.getElementById('enableExternalSubtitles').checked;

                const configData = {
                    tmdbApiKey: key,
                    traktClientId: traktClientId,
                    rapidApiKey: rapidApiKey,
                    enableSearchFilter: false,
                    forceTVClientLocalSearch: forceTVLocal,
                    enableAutoImport: enableAutoImport,
                    disableModal: disableModal,
                    showReviewsCarousel: showReviewsCarousel,
                    reviewSource: reviewSource,
                    versionUi: versionUi,
                    audioUi: audioUi,
                    subtitleUi: subtitleUi,
                    audioUi: audioUi,
                    subtitleUi: subtitleUi,
                    enableCaveaUI: enableCaveaUI,
                    catalogMaxItems: parseInt(document.getElementById('catalogsMaxItems').value) || 100,
                    useCaveaCache: false, // Defaulting to false as UI removed
                    useCaveaStaging: false, // Defaulting to false as UI removed
                    enableExternalSubtitles: enableExternalSubtitles
                };

                try {
                    // Prefer ApiClient.ajax which includes authentication and proper headers
                    if (window.ApiClient && window.ApiClient.ajax) {
                        const ajaxOpts = {
                            type: 'PUT',
                            url: window.ApiClient.getUrl('api/cavea/config'),
                            data: JSON.stringify(configData),
                            contentType: 'application/json'
                        };
                        const res = await window.ApiClient.ajax(ajaxOpts);
                        console.log('[Cavea][Config] ApiClient.ajax PUT result:', res);
                        // Some ApiClient implementations return Response-like objects
                        if (res && ((res.status && res.status === 403) || (res.statusCode && res.statusCode === 403))) {
                            document.getElementById('configStatus').textContent = 'Forbidden: admin only';
                            return;
                        }
                        // If res is a Response-like object, check ok
                        if (res && res.constructor && res.constructor.name === 'Response') {
                            if (!res.ok) {
                                document.getElementById('configStatus').textContent = 'Error saving configuration';
                                console.error('[Cavea][Config] PUT failed (Response):', res);
                                return;
                            }
                        }
                        // Update cached plugin config in page context so client code picks it up immediately
                        try { if (window.MediaServerUI) window.MediaServerUI._pluginConfig = configData; } catch (e) { }
                        document.getElementById('configStatus').textContent = 'Configuration saved successfully!';
                        return;
                    }

                    const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/cavea/config') : (window.location.origin + '/api/cavea/config');
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(configData),
                        credentials: 'same-origin'
                    });
                    console.log('[Cavea][Config] fetch PUT result:', res);
                    if (res.status === 403) {
                        document.getElementById('configStatus').textContent = 'Forbidden: admin only';
                        return;
                    }
                    if (!res.ok) throw new Error('Save failed');
                    try { if (window.MediaServerUI) window.MediaServerUI._pluginConfig = configData; } catch (e) { }
                    document.getElementById('configStatus').textContent = 'Configuration saved successfully!';
                } catch (err) {
                    document.getElementById('configStatus').textContent = 'Error saving configuration';
                    console.error('[Cavea][Config] Save error:', err);
                }
            });

            loadConfig().catch(err => {
                console.error('[Cavea][Config] Failed to load config:', err);
            });


            // --- Catalogs Management ---
            const CATALOGS_API = 'api/cavea/catalogs';
            let catalogsData = [];
            let catalogFilter = 'all'; // 'all', 'imported', 'not-imported'
            const selectedCatalogs = new Set(); // Track selected catalog IDs

            // Filter dropdown toggle
            document.getElementById('catalogFilterBtn').addEventListener('click', function (e) {
                e.stopPropagation();
                const dropdown = document.getElementById('catalogFilterDropdown');
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function () {
                document.getElementById('catalogFilterDropdown').style.display = 'none';
            });

            // Filter option selection
            document.querySelectorAll('.catalog-filter-option').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    catalogFilter = this.dataset.filter;
                    document.querySelectorAll('.catalog-filter-option').forEach(b => b.style.background = 'transparent');
                    this.style.background = 'rgba(30,144,255,0.3)';
                    const labels = { 'all': 'All', 'imported': 'Imported', 'not-imported': 'Not Imported' };
                    document.getElementById('catalogFilterLabel').textContent = '(' + labels[catalogFilter] + ')';
                    document.getElementById('catalogFilterDropdown').style.display = 'none';
                    renderCatalogs();
                });
            });

            async function loadCatalogs() {
                const loading = document.getElementById('catalogsLoading');
                const error = document.getElementById('catalogsError');
                const list = document.getElementById('catalogsList');

                loading.style.display = 'block';
                error.style.display = 'none';
                list.innerHTML = '';

                try {
                    const url = (window.ApiClient && window.ApiClient.getUrl)
                        ? window.ApiClient.getUrl(CATALOGS_API)
                        : (window.location.origin + '/' + CATALOGS_API);

                    let response;
                    if (window.ApiClient && window.ApiClient.ajax) {
                        response = await window.ApiClient.ajax({ type: 'GET', url: url, dataType: 'json' });
                        if (response && response.constructor && response.constructor.name === 'Response') {
                            response = await response.json();
                        }
                    } else {
                        const res = await fetch(url, { credentials: 'same-origin' });
                        if (!res.ok) throw new Error('Failed to fetch catalogs');
                        response = await res.json();
                    }

                    catalogsData = response || [];
                    renderCatalogs();
                } catch (e) {
                    console.error('[Cavea] Failed to load catalogs:', e);
                    error.textContent = 'Failed to load catalogs: ' + e.message;
                    error.style.display = 'block';
                } finally {
                    loading.style.display = 'none';
                }
            }

            function renderCatalogs() {
                const list = document.getElementById('catalogsList');
                if (catalogsData.length === 0) {
                    list.innerHTML = '<div style="padding: 16px; text-align: center; color: #888;">No catalogs found. Make sure Gelato is configured with a valid aiostreams manifest.</div>';
                    return;
                }

                console.log('[Cavea] Rendering catalogs:', catalogsData);

                let html = '';
                for (let i = 0; i < catalogsData.length; i++) {
                    const cat = catalogsData[i];

                    // Apply filter
                    const isImported = !!cat.existingCollectionId;
                    if (catalogFilter === 'imported' && !isImported) continue;
                    if (catalogFilter === 'not-imported' && isImported) continue;

                    const icon = cat.type === 'series' ? 'üì∫' : 'üé¨';
                    const name = escapeHtml(cat.name || cat.id || 'Unknown');
                    const type = escapeHtml(cat.type || 'unknown');
                    const catId = escapeHtml(cat.id || '');
                    const sourceUrl = cat.sourceUrl || '';
                    const searchText = (name + ' ' + (cat.addonName || '')).toLowerCase();
                    // Use composite key (id:type) to uniquely identify catalogs since same ID can exist for movie and series
                    var catalogKey = cat.id + ':' + cat.type;
                    const isSelected = selectedCatalogs.has(catalogKey);

                    // Get existing/total counts
                    const existingId = cat.existingCollectionId;
                    const existingCount = cat.existingItemCount || 0;
                    const totalCount = cat.itemCount >= 0 ? cat.itemCount : '?';
                    const customName = cat.collectionName && cat.collectionName !== name ? cat.collectionName : '';

                    html += '<div class="catalog-item" data-search="' + escapeHtml(searchText) + '" style="display: flex; align-items: center; gap: 10px; padding: 12px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">';

                    // Checkbox
                    html += '<input type="checkbox" class="catalog-checkbox" data-key="' + catalogKey + '" data-id="' + cat.id + '" data-name="' + name + '" data-type="' + cat.type + '" ' + (isSelected ? 'checked' : '') + ' style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">';

                    // Type chip first
                    html += '<span style="font-size: 0.7em; padding: 2px 6px; background: ' + (type === 'series' ? '#9b59b6' : '#1e90ff') + '; color: white; border-radius: 4px; text-transform: uppercase; flex-shrink: 0;">' + type + '</span>';

                    // Name + custom name + link
                    html += '<div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">';
                    html += '<span style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + name + '</span>';
                    if (customName) {
                        html += '<span style="color: #2ecc71; font-size: 0.9em;">- (' + escapeHtml(customName) + ')</span>';
                    }
                    if (sourceUrl) {
                        html += '<a href="' + escapeHtml(sourceUrl) + '" target="_blank" rel="noopener" style="text-decoration: none; color: #1e90ff; font-size: 1em;" title="Open source page">üîó</a>';
                    }
                    html += '</div>';

                    // Show existing/total count for collections
                    if (existingId) {
                        if (totalCount !== '?' && totalCount > 0) {
                            html += '<span style="font-size: 0.85em; color: #2ecc71; font-weight: 500; flex-shrink: 0;">' + existingCount + '/' + totalCount + '</span>';
                        } else if (existingCount > 0) {
                            html += '<span style="font-size: 0.85em; color: #2ecc71; font-weight: 500; flex-shrink: 0;">' + existingCount + ' items</span>';
                        } else {
                            html += '<span style="font-size: 0.85em; color: #666; flex-shrink: 0;">empty</span>';
                        }
                    }

                    html += '</div>';
                }
                list.innerHTML = html;

                // Add event listeners for checkboxes - use composite key
                list.querySelectorAll('.catalog-checkbox').forEach(function (checkbox) {
                    checkbox.addEventListener('change', function () {
                        var key = this.dataset.key; // composite key (id:type)
                        if (this.checked) {
                            selectedCatalogs.add(key);
                        } else {
                            selectedCatalogs.delete(key);
                        }
                        updateSelectionUI();
                    });
                });
            }

            function escapeHtml(str) {
                if (!str) return '';
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }

            // --- Selection UI Logic ---
            function updateSelectionUI() {
                const count = selectedCatalogs.size;
                const btn = document.getElementById('catalogsImportSelectedBtn');
                const countEl = document.getElementById('catalogsSelectedCount');
                const selectAllCheckbox = document.getElementById('catalogSelectAll');

                countEl.textContent = count;
                btn.disabled = count === 0;
                btn.style.opacity = count === 0 ? '0.5' : '1';

                // Update Select All checkbox state
                const visibleCheckboxes = document.querySelectorAll('.catalog-checkbox');
                const allChecked = visibleCheckboxes.length > 0 && Array.from(visibleCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = count > 0 && !allChecked;
            }

            // Select All checkbox handler - use composite key
            document.getElementById('catalogSelectAll').addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.catalog-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    var key = cb.dataset.key; // composite key (id:type)
                    if (this.checked) {
                        selectedCatalogs.add(key);
                    } else {
                        selectedCatalogs.delete(key);
                    }
                });
                updateSelectionUI();
            });

            // Import Selected button handler
            document.getElementById('catalogsImportSelectedBtn').addEventListener('click', function () {
                if (selectedCatalogs.size === 0) return;
                openBulkImportModal();
            });

            // --- Bulk Import Modal Logic ---
            const bulkImportModal = document.getElementById('bulkImportModal');
            const bulkImportList = document.getElementById('bulkImportList');
            const cancelBulkImportBtn = document.getElementById('cancelBulkImportBtn');
            const confirmBulkImportBtn = document.getElementById('confirmBulkImportBtn');
            let bulkImportInProgress = false;

            function openBulkImportModal() {
                // Filter using composite key (id:type)
                const selectedData = catalogsData.filter(function (c) { return selectedCatalogs.has(c.id + ':' + c.type); });
                document.getElementById('bulkImportCount').textContent = selectedData.length;

                // Reset progress UI
                document.getElementById('bulkImportProgress').style.display = 'none';
                document.getElementById('bulkImportProgressBar').style.width = '0%';
                confirmBulkImportBtn.disabled = false;
                confirmBulkImportBtn.textContent = 'Start Import';
                cancelBulkImportBtn.disabled = false;

                const listContainer = document.getElementById('bulkImportList');
                listContainer.innerHTML = '';

                // --- Global Options Header ---
                const headerDiv = document.createElement('div');
                headerDiv.style.marginBottom = '10px';
                headerDiv.innerHTML = '<p style="color:#aaa;font-size:12px;margin:0 0 5px 0;">Check "Merge" to combine items into the Global Collection. <strong>Leave unchecked</strong> to import as separate collections with their own names.</p>';

                const controlsDiv = document.createElement('div');
                controlsDiv.style.marginBottom = '15px';
                controlsDiv.style.padding = '10px';
                controlsDiv.style.background = 'rgba(30, 144, 255, 0.1)';
                controlsDiv.style.border = '1px solid rgba(30, 144, 255, 0.3)';
                controlsDiv.style.borderRadius = '6px';
                controlsDiv.style.display = 'flex';
                controlsDiv.style.alignItems = 'center';
                controlsDiv.style.gap = '10px';

                controlsDiv.innerHTML = '<span style="font-size:1.5em">üì¶</span>';

                // Global Name Input
                const globalNameInput = document.createElement('input');
                globalNameInput.type = 'text';
                globalNameInput.id = 'bulkImportGlobalName';
                globalNameInput.placeholder = 'Merged Collection Name (only for checked items)';
                globalNameInput.style.flex = '1';
                globalNameInput.style.padding = '8px';
                globalNameInput.style.background = '#111';
                globalNameInput.style.border = '1px solid #444';
                globalNameInput.style.borderRadius = '4px';
                globalNameInput.style.color = '#fff';
                globalNameInput.disabled = true; // Disabled strictly by default
                controlsDiv.appendChild(globalNameInput);

                listContainer.appendChild(headerDiv);
                listContainer.appendChild(controlsDiv);

                // --- Items List ---
                const itemsContainer = document.createElement('div');
                itemsContainer.style.maxHeight = '300px';
                itemsContainer.style.overflowY = 'auto';

                selectedData.forEach((cat, i) => {
                    const icon = cat.type === 'series' ? 'üì∫' : 'üé¨';
                    const catName = cat.name || cat.id;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bulk-import-item';
                    itemDiv.dataset.id = cat.id;
                    itemDiv.dataset.type = cat.type;
                    itemDiv.style.display = 'flex';
                    itemDiv.style.alignItems = 'center';
                    itemDiv.style.gap = '10px';
                    itemDiv.style.padding = '8px';
                    itemDiv.style.marginBottom = '6px';
                    itemDiv.style.background = 'rgba(255,255,255,0.05)';
                    itemDiv.style.borderRadius = '4px';

                    // Merge Checkbox
                    const mergeCb = document.createElement('input');
                    mergeCb.type = 'checkbox';
                    mergeCb.className = 'item-merge-checkbox';
                    mergeCb.title = 'Merge into unified collection';
                    mergeCb.style.cursor = 'pointer';
                    mergeCb.style.width = '16px';
                    mergeCb.style.height = '16px';
                    itemDiv.appendChild(mergeCb);

                    itemDiv.appendChild(mergeCb);

                    // Merge Label
                    const mergeLabel = document.createElement('span');
                    mergeLabel.textContent = 'Merge';
                    mergeLabel.style.fontSize = '11px';
                    mergeLabel.style.color = '#888';
                    mergeLabel.style.marginRight = '8px';
                    itemDiv.appendChild(mergeLabel);

                    // Icon
                    const iconSpan = document.createElement('span');
                    iconSpan.textContent = icon;
                    iconSpan.style.fontSize = '1.3em';
                    itemDiv.appendChild(iconSpan);

                    // Input (Individual)
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'bulk-import-name';
                    input.value = catName;
                    input.dataset.originalName = catName;
                    input.style.flex = '1';
                    input.style.padding = '6px 10px';
                    input.style.border = '1px solid #444';
                    input.style.borderRadius = '4px';
                    input.style.background = '#111';
                    input.style.color = '#fff';
                    input.style.fontSize = '13px';
                    itemDiv.appendChild(input);

                    // Status
                    const status = document.createElement('span');
                    status.className = 'bulk-import-status';
                    status.id = 'status-' + cat.id + '-' + cat.type;
                    status.textContent = 'Pending';
                    status.style.fontSize = '12px';
                    status.style.color = '#888';
                    status.style.minWidth = '60px';
                    status.style.textAlign = 'right';
                    itemDiv.appendChild(status);

                    itemsContainer.appendChild(itemDiv);

                    // Handler for this row
                    mergeCb.addEventListener('change', function () {
                        const isChecked = this.checked;
                        input.disabled = isChecked;
                        input.style.opacity = isChecked ? '0.3' : '1';

                        // Update Global Input State
                        updateGlobalHeaderState();
                    });
                });

                listContainer.appendChild(itemsContainer);

                function updateGlobalHeaderState() {
                    const anyChecked = listContainer.querySelectorAll('.item-merge-checkbox:checked').length > 0;
                    globalNameInput.disabled = !anyChecked;
                    globalNameInput.style.borderColor = anyChecked ? '#1e90ff' : '#444';
                    if (anyChecked && !globalNameInput.value) {
                        // Optional: Suggest name from first checked item
                        const firstChecked = listContainer.querySelector('.item-merge-checkbox:checked');
                        if (firstChecked) {
                            const row = firstChecked.closest('.bulk-import-item');
                            const name = row.querySelector('.bulk-import-name').dataset.originalName;
                            globalNameInput.value = name;
                        }
                    }
                }

                bulkImportModal.style.display = 'flex';
            }

            function renderMultiInputs() {
                // No-op, removed
            }

            cancelBulkImportBtn.addEventListener('click', function () {
                if (bulkImportInProgress) return;
                bulkImportModal.style.display = 'none';
            });

            confirmBulkImportBtn.addEventListener('click', async function () {
                if (bulkImportInProgress) return;
                bulkImportInProgress = true;

                confirmBulkImportBtn.disabled = true;
                cancelBulkImportBtn.disabled = true;

                // Global Name
                const globalName = document.getElementById('bulkImportGlobalName').value;

                // Collect requests
                const importRequests = [];
                const items = document.querySelectorAll('.bulk-import-item');

                items.forEach(item => {
                    const catId = item.dataset.id;
                    const catType = item.dataset.type;
                    const mergeCb = item.querySelector('.item-merge-checkbox');
                    const input = item.querySelector('.bulk-import-name');
                    const statusId = 'status-' + catId + '-' + catType;

                    const isMerged = mergeCb.checked;

                    if (isMerged) {
                        // Merge into unified collection with Global Name
                        importRequests.push({
                            catId: catId,
                            catType: catType,
                            catName: globalName || catId, // Should rely on global name for merging
                            separate: false,
                            statusElemId: statusId
                        });
                    } else {
                        // Import separately with Individual Name
                        importRequests.push({
                            catId: catId,
                            catType: catType,
                            catName: input.value || catId,
                            separate: true,
                            statusElemId: statusId
                        });
                    }
                });

                const total = importRequests.length;

                // Close modal immediately
                bulkImportModal.style.display = 'none';
                bulkImportInProgress = false;

                // Show toast notification
                if (window.Dashboard && window.Dashboard.alert) {
                    window.Dashboard.alert({ message: 'Starting import of ' + total + ' catalog(s). Check the catalog list for progress.', title: 'Import Started' });
                } else {
                    alert('Starting import of ' + total + ' catalog(s). Check the catalog list for progress.');
                }

                // Clear selection
                selectedCatalogs.clear();
                updateSelectionUI();

                // Fire off imports sequentially (backend handles queue)
                for (const req of importRequests) {
                    try {
                        // Update status if modal was open? No, modal is closed. 
                        // We rely on toasts.
                        await importCatalog(req.catId, req.catType, req.catName, req.catName, null, req.separate);
                    } catch (e) {
                        console.error('[Cavea] Import error for', req.catId, e);
                    }
                }

                // Refresh catalog list when all done
                loadCatalogs();
            });

            // --- Create Library Modal Logic ---
            const createLibModal = document.getElementById('createLibraryModal');
            const createLibNameDisplay = document.getElementById('createLibraryName');
            const createLibInputName = document.getElementById('createLibraryInputName');
            const cancelCreateLibBtn = document.getElementById('cancelCreateLibBtn');
            const confirmCreateLibBtn = document.getElementById('confirmCreateLibBtn');

            let currentCatalogId = null;
            let currentCatalogType = null;
            let currentCatalogName = null;

            cancelCreateLibBtn.onclick = () => { createLibModal.style.display = 'none'; };

            function openCreateLibraryModal(catId, catType, catName) {
                currentCatalogId = catId;
                currentCatalogType = catType;
                currentCatalogName = catName;

                createLibNameDisplay.textContent = catName;
                createLibInputName.value = catName;

                confirmCreateLibBtn.textContent = 'Create Collection';
                confirmCreateLibBtn.disabled = false;

                createLibModal.style.display = 'flex';
            }

            confirmCreateLibBtn.onclick = async () => {
                const libName = createLibInputName.value || currentCatalogName;
                const catalogIdCopy = currentCatalogId; // Copy for closure

                confirmCreateLibBtn.textContent = '‚è≥ 0%';
                confirmCreateLibBtn.disabled = true;

                try {
                    await importCatalog(catalogIdCopy, currentCatalogType, currentCatalogName, libName, (progress) => {
                        if (progress.status === 'running' || progress.status === 'queued') {
                            confirmCreateLibBtn.textContent = `‚è≥ ${progress.percent}%`;
                        } else if (progress.status === 'complete') {
                            confirmCreateLibBtn.textContent = '‚úì Done';
                        }
                    });
                    setTimeout(() => { createLibModal.style.display = 'none'; }, 500);
                } catch (e) {
                    Dashboard.alert({ message: 'Error: ' + e.message, title: 'Error' });
                    confirmCreateLibBtn.textContent = 'Retry';
                    confirmCreateLibBtn.disabled = false;
                }
            };

            async function importCatalog(catalogId, catalogType, catalogName, libraryName, onProgress = null, separate = false) {
                const url = (window.ApiClient && window.ApiClient.getUrl)
                    ? window.ApiClient.getUrl(CATALOGS_API + '/' + encodeURIComponent(catalogId) + '/library') + '?type=' + catalogType + '&separate=' + separate
                    : (window.location.origin + '/' + CATALOGS_API + '/' + encodeURIComponent(catalogId) + '/library?type=' + catalogType + '&separate=' + separate);

                try {
                    let response;
                    const maxItems = parseInt(document.getElementById('catalogsMaxItems')?.value) || 100;
                    const payload = JSON.stringify({ maxItems: maxItems, collectionName: libraryName });

                    if (window.ApiClient && window.ApiClient.ajax) {
                        response = await window.ApiClient.ajax({
                            type: 'POST',
                            url: url,
                            data: payload,
                            contentType: 'application/json'
                        });
                        if (response && response.constructor && response.constructor.name === 'Response') {
                            response = await response.json();
                        }
                    } else {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: payload,
                            credentials: 'same-origin'
                        });
                        response = await res.json();
                    }

                    if (response && response.success) {
                        // Start polling for progress if callback provided
                        if (onProgress) {
                            await pollImportProgress(catalogId, onProgress);
                        }
                        return response;
                    } else {
                        const msg = response?.message || 'Unknown error';
                        throw new Error(msg);
                    }
                } catch (e) {
                    console.error(e);
                    throw e;
                }
            }

            // Poll import progress endpoint until complete
            async function pollImportProgress(catalogId, onProgress) {
                const progressUrl = (window.ApiClient && window.ApiClient.getUrl)
                    ? window.ApiClient.getUrl(CATALOGS_API + '/' + encodeURIComponent(catalogId) + '/progress')
                    : (window.location.origin + '/' + CATALOGS_API + '/' + encodeURIComponent(catalogId) + '/progress');

                let complete = false;
                while (!complete) {
                    try {
                        let progress;
                        if (window.ApiClient && window.ApiClient.ajax) {
                            progress = await window.ApiClient.ajax({ type: 'GET', url: progressUrl, dataType: 'json' });
                            if (progress && progress.constructor && progress.constructor.name === 'Response') {
                                progress = await progress.json();
                            }
                        } else {
                            const res = await fetch(progressUrl, { credentials: 'same-origin' });
                            progress = await res.json();
                        }

                        if (onProgress) onProgress(progress);

                        if (progress.status === 'complete' || progress.status === 'error' || progress.status === 'idle') {
                            complete = true;
                        } else {
                            await new Promise(r => setTimeout(r, 500)); // Poll every 500ms
                        }
                    } catch (e) {
                        console.error('[Cavea] Progress poll error:', e);
                        complete = true;
                    }
                }
            }

            // --- Update Preview Modal Logic ---
            const updatePreviewModal = document.getElementById('updatePreviewModal');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const confirmUpdateBtn = document.getElementById('confirmUpdateBtn');
            const previewExisting = document.getElementById('previewExisting');
            const previewNew = document.getElementById('previewNew');
            const previewRemoved = document.getElementById('previewRemoved');
            const previewTotal = document.getElementById('previewTotal');
            const previewMessage = document.getElementById('previewMessage');

            let previewCatalogId, previewType, previewName;

            closePreviewBtn.onclick = () => { updatePreviewModal.style.display = 'none'; };

            async function openUpdatePreviewModal(catId, catType, catName) {
                previewCatalogId = catId;
                previewType = catType;
                previewName = catName;

                // Reset UI
                updatePreviewModal.style.display = 'flex';
                confirmUpdateBtn.style.display = 'none';
                previewExisting.textContent = 'Loading...';
                previewNew.textContent = '-';
                previewRemoved.textContent = '-';
                previewTotal.textContent = '-';
                previewMessage.textContent = 'Comparing catalog with collection...';
                previewMessage.style.color = '#bdc3c7';

                try {
                    const maxItems = parseInt(document.getElementById('catalogsMaxItems')?.value) || 100;
                    const url = (window.ApiClient && window.ApiClient.getUrl)
                        ? window.ApiClient.getUrl(CATALOGS_API + '/' + encodeURIComponent(catId) + '/preview-update') + '?type=' + catType
                        : (window.location.origin + '/' + CATALOGS_API + '/' + encodeURIComponent(catId) + '/preview-update?type=' + catType);

                    const payload = JSON.stringify({ maxItems: maxItems });

                    let response;
                    if (window.ApiClient && window.ApiClient.ajax) {
                        response = await window.ApiClient.ajax({
                            type: 'POST',
                            url: url,
                            data: payload,
                            contentType: 'application/json'
                        });
                        if (response && response.constructor && response.constructor.name === 'Response') {
                            response = await response.json();
                        }
                    } else {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: payload,
                            credentials: 'same-origin'
                        });
                        response = await res.json();
                    }

                    // Update Stats
                    previewExisting.textContent = response.existingItems;
                    previewNew.textContent = response.newItems;
                    previewRemoved.textContent = response.removedItems;
                    previewTotal.textContent = response.totalCatalogItems;

                    if (response.newItems > 0 || response.removedItems > 0) {
                        previewMessage.textContent = `Updates available: ${response.newItems} new items found.`;
                        previewMessage.style.color = '#2ecc71';
                        confirmUpdateBtn.style.display = 'block';
                        confirmUpdateBtn.textContent = 'Update Collection';
                        confirmUpdateBtn.disabled = false;
                    } else {
                        previewMessage.textContent = 'Collection is up to date!';
                        previewMessage.style.color = '#3498db';
                    }

                } catch (e) {
                    previewMessage.textContent = 'Error checking for updates: ' + e.message;
                    previewMessage.style.color = '#e74c3c';
                }
            }

            confirmUpdateBtn.onclick = async () => {
                confirmUpdateBtn.textContent = 'Updating...';
                confirmUpdateBtn.disabled = true;
                try {
                    // Reuse importCatalog which does add-only logic for now
                    await importCatalog(previewCatalogId, previewType, previewName, null);
                    updatePreviewModal.style.display = 'none';
                } catch (e) {
                    Dashboard.alert({ message: 'Error: ' + e.message, title: 'Error' });
                    confirmUpdateBtn.disabled = false;
                }
            };

            document.getElementById('catalogsRefreshBtn').addEventListener('click', loadCatalogs);

            // Load saved max items from localStorage
            const maxItemsInput = document.getElementById('catalogsMaxItems');
            const savedMaxItems = localStorage.getItem('cavea_catalog_max_items');
            if (savedMaxItems && maxItemsInput) {
                maxItemsInput.value = savedMaxItems;
            }

            // Save max items to localStorage on change
            // Save max items to localStorage on change
            if (maxItemsInput) {
                maxItemsInput.addEventListener('change', function () {
                    localStorage.setItem('cavea_catalog_max_items', this.value);
                });
            }

            // Search Filter Logic
            const searchInput = document.getElementById('catalogSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function (e) {
                    const term = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('.catalog-item');
                    rows.forEach(function (row) {
                        const searchVal = row.getAttribute('data-search') || '';
                        row.style.display = searchVal.indexOf(term) > -1 ? 'flex' : 'none';
                    });
                });
            }

            loadCatalogs(); // Load on startup

        </script>
    </div>
    </div>
    </div>

    <script type="text/javascript">
        console.log('[Cavea] Configuration page loaded');
    </script>
</body>

</html>